name: Multi-Ubuntu-RDP
on:
  workflow_dispatch:
    inputs:
      instance_count:
        description: 'Number of RDP instances (1-10)'
        required: true
        default: '3'
      session_duration:
        description: 'Session duration (minutes)'
        required: false
        default: '360'

jobs:
  ubuntu-rdp-1:
    runs-on: ubuntu-latest
    timeout-minutes: 360
    
    steps:
      - name: Setup RDP Instance 1
        run: |
          echo "================================"
          echo "    RDP INSTANCE #1"
          echo "================================"
          echo "OS: $(lsb_release -d | cut -f2)"
          echo "CPU: $(nproc) cores"
          echo "RAM: $(free -h | awk '/^Mem:/ {print $2}')"
          echo "================================"

      - name: Install XFCE Desktop
        run: |
          sudo apt-get update -qq
          sudo DEBIAN_FRONTEND=noninteractive apt-get install -y -qq \
            xfce4 xfce4-goodies dbus-x11 xorg xrdp firefox nano htop net-tools

      - name: Configure XRDP
        run: |
          sudo tee /etc/xrdp/startwm.sh > /dev/null << 'EOF'
          #!/bin/sh
          if [ -r /etc/default/locale ]; then
            . /etc/default/locale
            export LANG LANGUAGE
          fi
          startxfce4
          EOF
          
          sudo chmod +x /etc/xrdp/startwm.sh
          sudo sed -i 's/max_bpp=32/max_bpp=24/' /etc/xrdp/xrdp.ini
          sudo systemctl enable xrdp
          sudo systemctl start xrdp
          sudo ufw allow 3389/tcp

      - name: Create User
        run: |
          sudo useradd -m -s /bin/bash rdp1
          echo "rdp1:Pass1234!" | sudo chpasswd
          sudo usermod -aG sudo rdp1
          echo "RDP_USER_1=rdp1" >> $GITHUB_ENV
          echo "RDP_PASS_1=Pass1234!" >> $GITHUB_ENV

      - name: Install Tailscale
        run: |
          curl -fsSL https://pkgs.tailscale.com/stable/ubuntu/jammy.noarmor.gpg | sudo tee /usr/share/keyrings/tailscale-archive-keyring.gpg >/dev/null
          curl -fsSL https://pkgs.tailscale.com/stable/ubuntu/jammy.tailscale-keyring.list | sudo tee /etc/apt/sources.list.d/tailscale.list
          sudo apt-get update -qq
          sudo apt-get install -y -qq tailscale

      - name: Connect Tailscale
        run: |
          sudo tailscale up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} --hostname=rdp-instance-1
          
          RETRY=0
          while [ $RETRY -lt 20 ]; do
            TAILSCALE_IP=$(tailscale ip -4 2>/dev/null)
            if [ -n "$TAILSCALE_IP" ]; then
              echo "TAILSCALE_IP_1=$TAILSCALE_IP" >> $GITHUB_ENV
              echo "✓ Instance 1 IP: $TAILSCALE_IP"
              break
            fi
            sleep 3
            RETRY=$((RETRY+1))
          done

      - name: Display Info
        run: |
          echo ""
          echo "╔════════════════════════════════════════╗"
          echo "║       RDP INSTANCE #1                  ║"
          echo "╠════════════════════════════════════════╣"
          echo "║ IP       : $TAILSCALE_IP_1"
          echo "║ Username : $RDP_USER_1"
          echo "║ Password : $RDP_PASS_1"
          echo "╚════════════════════════════════════════╝"

      - name: Keep Alive
        run: |
          START=$(date +%s)
          DURATION=$((360 * 60))
          END=$((START + DURATION))
          
          while [ $(date +%s) -lt $END ]; do
            ELAPSED=$((($(date +%s) - START) / 60))
            REMAIN=$(((END - $(date +%s)) / 60))
            echo "[Instance 1] Active | ${ELAPSED}m elapsed | ${REMAIN}m remaining"
            sleep 60
          done

  ubuntu-rdp-2:
    runs-on: ubuntu-latest
    timeout-minutes: 360
    if: ${{ github.event.inputs.instance_count >= 2 }}
    
    steps:
      - name: Setup RDP Instance 2
        run: |
          echo "================================"
          echo "    RDP INSTANCE #2"
          echo "================================"

      - name: Install XFCE Desktop
        run: |
          sudo apt-get update -qq
          sudo DEBIAN_FRONTEND=noninteractive apt-get install -y -qq \
            xfce4 xfce4-goodies dbus-x11 xorg xrdp firefox nano htop net-tools

      - name: Configure XRDP
        run: |
          sudo tee /etc/xrdp/startwm.sh > /dev/null << 'EOF'
          #!/bin/sh
          if [ -r /etc/default/locale ]; then
            . /etc/default/locale
            export LANG LANGUAGE
          fi
          startxfce4
          EOF
          
          sudo chmod +x /etc/xrdp/startwm.sh
          sudo sed -i 's/max_bpp=32/max_bpp=24/' /etc/xrdp/xrdp.ini
          sudo systemctl enable xrdp
          sudo systemctl start xrdp
          sudo ufw allow 3389/tcp

      - name: Create User
        run: |
          sudo useradd -m -s /bin/bash rdp2
          echo "rdp2:Pass1234!" | sudo chpasswd
          sudo usermod -aG sudo rdp2

      - name: Install Tailscale
        run: |
          curl -fsSL https://pkgs.tailscale.com/stable/ubuntu/jammy.noarmor.gpg | sudo tee /usr/share/keyrings/tailscale-archive-keyring.gpg >/dev/null
          curl -fsSL https://pkgs.tailscale.com/stable/ubuntu/jammy.tailscale-keyring.list | sudo tee /etc/apt/sources.list.d/tailscale.list
          sudo apt-get update -qq
          sudo apt-get install -y -qq tailscale

      - name: Connect Tailscale
        run: |
          sudo tailscale up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} --hostname=rdp-instance-2
          
          RETRY=0
          while [ $RETRY -lt 20 ]; do
            TAILSCALE_IP=$(tailscale ip -4 2>/dev/null)
            if [ -n "$TAILSCALE_IP" ]; then
              echo "✓ Instance 2 IP: $TAILSCALE_IP"
              break
            fi
            sleep 3
            RETRY=$((RETRY+1))
          done

      - name: Display Info
        run: |
          TAILSCALE_IP=$(tailscale ip -4)
          echo ""
          echo "╔════════════════════════════════════════╗"
          echo "║       RDP INSTANCE #2                  ║"
          echo "╠════════════════════════════════════════╣"
          echo "║ IP       : $TAILSCALE_IP"
          echo "║ Username : rdp2"
          echo "║ Password : Pass1234!"
          echo "╚════════════════════════════════════════╝"

      - name: Keep Alive
        run: |
          START=$(date +%s)
          DURATION=$((360 * 60))
          END=$((START + DURATION))
          
          while [ $(date +%s) -lt $END ]; do
            ELAPSED=$((($(date +%s) - START) / 60))
            REMAIN=$(((END - $(date +%s)) / 60))
            echo "[Instance 2] Active | ${ELAPSED}m elapsed | ${REMAIN}m remaining"
            sleep 60
          done

  ubuntu-rdp-3:
    runs-on: ubuntu-latest
    timeout-minutes: 360
    if: ${{ github.event.inputs.instance_count >= 3 }}
    
    steps:
      - name: Setup RDP Instance 3
        run: |
          echo "================================"
          echo "    RDP INSTANCE #3"
          echo "================================"

      - name: Install XFCE Desktop
        run: |
          sudo apt-get update -qq
          sudo DEBIAN_FRONTEND=noninteractive apt-get install -y -qq \
            xfce4 xfce4-goodies dbus-x11 xorg xrdp firefox nano htop net-tools

      - name: Configure XRDP
        run: |
          sudo tee /etc/xrdp/startwm.sh > /dev/null << 'EOF'
          #!/bin/sh
          if [ -r /etc/default/locale ]; then
            . /etc/default/locale
            export LANG LANGUAGE
          fi
          startxfce4
          EOF
          
          sudo chmod +x /etc/xrdp/startwm.sh
          sudo sed -i 's/max_bpp=32/max_bpp=24/' /etc/xrdp/xrdp.ini
          sudo systemctl enable xrdp
          sudo systemctl start xrdp
          sudo ufw allow 3389/tcp

      - name: Create User
        run: |
          sudo useradd -m -s /bin/bash rdp3
          echo "rdp3:Pass1234!" | sudo chpasswd
          sudo usermod -aG sudo rdp3

      - name: Install Tailscale
        run: |
          curl -fsSL https://pkgs.tailscale.com/stable/ubuntu/jammy.noarmor.gpg | sudo tee /usr/share/keyrings/tailscale-archive-keyring.gpg >/dev/null
          curl -fsSL https://pkgs.tailscale.com/stable/ubuntu/jammy.tailscale-keyring.list | sudo tee /etc/apt/sources.list.d/tailscale.list
          sudo apt-get update -qq
          sudo apt-get install -y -qq tailscale

      - name: Connect Tailscale
        run: |
          sudo tailscale up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} --hostname=rdp-instance-3
          
          RETRY=0
          while [ $RETRY -lt 20 ]; do
            TAILSCALE_IP=$(tailscale ip -4 2>/dev/null)
            if [ -n "$TAILSCALE_IP" ]; then
              echo "✓ Instance 3 IP: $TAILSCALE_IP"
              break
            fi
            sleep 3
            RETRY=$((RETRY+1))
          done

      - name: Display Info
        run: |
          TAILSCALE_IP=$(tailscale ip -4)
          echo ""
          echo "╔════════════════════════════════════════╗"
          echo "║       RDP INSTANCE #3                  ║"
          echo "╠════════════════════════════════════════╣"
          echo "║ IP       : $TAILSCALE_IP"
          echo "║ Username : rdp3"
          echo "║ Password : Pass1234!"
          echo "╚════════════════════════════════════════╝"

      - name: Keep Alive
        run: |
          START=$(date +%s)
          DURATION=$((360 * 60))
          END=$((START + DURATION))
          
          while [ $(date +%s) -lt $END ]; do
            ELAPSED=$((($(date +%s) - START) / 60))
            REMAIN=$(((END - $(date +%s)) / 60))
            echo "[Instance 3] Active | ${ELAPSED}m elapsed | ${REMAIN}m remaining"
            sleep 60
          done
